function onMapAutocomplete(e,t){var n=e.val();var r="";if(n&&n.length>2){mapAutocomplete.getQueryPredictions({input:n},function(n,i){if(i==google.maps.places.PlacesServiceStatus.OK){for(var s=0,o;o=n[s];s++){r+='<li data-icon="false"><a class="search-autocomplete-select" href="#">'+o.description+"</a></li>"}onShowSearchList(e,t,r);$(".search-autocomplete-select").click(function(n){e.val($(this).text());onHideSearchList(t)})}})}else{onShowSearchList(e,t)}onSearchInputChanged(e,t)}function onShowSearchList(e,t,n){var r='<li data-icon="gps"><a class="search-autocomplete-select-gps" href="#">'+strCurrentLocation+"</a></li>";if(n){r=r+'<li data-role="list-divider">Suggestions</li>'+n}t.html(r);t.listview("refresh");t.trigger("updatelayout");$(".search-autocomplete-select-gps").click(function(n){e.val(strCurrentLocation);onHideSearchList(t)})}function onHideSearchList(e){e.html("");e.listview("refresh");e.trigger("updatelayout")}function onSearchInputChanged(e,t){if(e.val()==""){onHideSearchList(t)}onSearchChanged()}function onSearchChanged(){if($("#search-origin").val().length>0&&$("#search-destination").val().length>0){if($("#search-start").hasClass("ui-disabled")){$("#search-start").removeClass("ui-disabled");$("#search-start").button("refresh")}}else{if(!$("#search-start").hasClass("ui-disabled")){$("#search-start").addClass("ui-disabled");$("#search-start").button("refresh")}}}function onMapSearch(){var e=$("#search-origin").val();if(e==strCurrentLocation){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(t){onMapSearchOrigin(e,new google.maps.LatLng(t.coords.latitude,t.coords.longitude))},function(){alert("The current location is not available.")})}else{alert("The current location is not available.")}}else{mapGeocoder.geocode({address:e},function(t,n){if(n==google.maps.GeocoderStatus.OK){onMapSearchOrigin(e,t[0].geometry.location)}else{alert("Cannot find the origin address.")}})}}function onMapSearchOrigin(e,t){$.mobile.loading("show",{text:"",textVisible:false,theme:"f",textonly:false});var n=$("#search-destination").val();if(n==strCurrentLocation){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(r){onMapSearchDestination(e,n,t,new google.maps.LatLng(r.coords.latitude,r.coords.longitude))},function(){$.mobile.loading("hide");alert("The current location is not available.")})}else{$.mobile.loading("hide");alert("The current location is not available.")}}else{mapGeocoder.geocode({address:n},function(r,i){if(i==google.maps.GeocoderStatus.OK){onMapSearchDestination(e,n,t,r[0].geometry.location)}else{$.mobile.loading("hide");alert("Cannot find the destination address.")}})}}function onMapSearchDestination(e,t,n,r){$("#search-panel").panel("close");clearMap();var i=new google.maps.Marker({position:n,icon:mapMarkerFlagGreen,shadow:mapMarkerShadow,draggable:false,animation:google.maps.Animation.DROP,title:"Leave At"});var s=new google.maps.Marker({position:r,icon:mapMarkerFlagRed,shadow:mapMarkerShadow,flat:false,draggable:false,animation:google.maps.Animation.DROP,title:"Arrive At"});google.maps.event.addListener(i,"click",function(){mapInfoWndOrigin.setOptions({content:'<div class="map-info-window"><h3>'+e+"</h3></div>"});mapInfoWndOrigin.open(map,i)});google.maps.event.addListener(s,"click",function(){mapInfoWndDestination.setOptions({content:'<div class="map-info-window"><h3>'+t+"</h3></div>"});mapInfoWndDestination.open(map,s)});mapMarkersEnds.push(i);mapMarkersEnds.push(s);var o=new google.maps.LatLngBounds;for(var u=0;u<mapMarkersEnds.length;u++){o.extend(mapMarkersEnds[u].getPosition())}map.setCenter(o.getCenter());map.fitBounds(o);for(var u=0;u<mapMarkersEnds.length;u++){setTimeout(function(e){mapMarkersEnds[e].setMap(map)},500*u,u)}onRequestDirections(e,t,n,r)}function onRequestDirections(e,t,n,r){var i=isNow?new Date:new Date($("#search-date-time").val());var s="http://bicing.h2o.net.br/getroute.php?origin="+n.lat()+","+n.lng()+"&destination="+r.lat()+","+r.lng()+"&time="+i.getTime();isIgnoreCollapsible=true;$.ajax(s,{timeout:6e4}).done(function(i){searchResult=i;var s='<div class="ui-panel-inner">';$.each(i,function(n,r){var i=Math.ceil(r.time.depToStation/60);var o=Math.ceil(r.time.bicing/60);var u=Math.ceil(r.time.stationToDest/60);s+='<div data-role="collapsible-set" data-content-theme="f">'+'<div class=".result-collapsible" data-role="collapsible" data-mini="true" data-collapsed="'+(n==0?"false":"true")+'" style="font-size:80%">'+"<h3>"+formatDistance(r.distance.sum)+" ("+r.print.sumTime+")</h3>"+'<table border="0" cellspacing="0" cellpadding="0">'+'<tr><td rowspan="1" valign="top"><img src="images/PinFlatFlagGreen_100.png" width="50" height="50" alt="Origin address" /></td>'+"<td><b>Leave at</b><br/>"+e+"</td></tr>"+'<tr><td rowspan="1" valign="top"><img src="images/PinFlatBiciGreen_100.png" width="50" height="50" alt="Origin station" /></td>'+"<td><b>Get bike at (+"+i+" min)</b><br/>"+r.station.start.street+" "+r.station.start.street_number+"<br/>Station: "+r.station.start.station_id+"<br/>Bikes now: "+r.station.start.bikes+"<br/>Bikes estimated: "+r.station.start.estimation.bikes+"</td></tr>"+'<tr><td rowspan="1" valign="top"><img src="images/PinFlatBiciRed_100.png" width="50" height="50" alt="Destination station" /></td>'+"<td><b>Leave bike at (+"+o+" min)</b><br/>"+r.station.arrive.street+" "+r.station.arrive.street_number+"<br/>Station: "+r.station.start.station_id+"<br/>Slots now: "+r.station.start.slots+"<br/>Slots estimated: "+r.station.start.estimation.slots+"</td></tr>"+'<tr><td rowspan="1" valign="top"><img src="images/PinFlatFlagRed_100.png" width="50" height="50" alt="Destination station" /></td>'+"<td><b>Arrive at (+"+u+" min)</b><br/>"+t+"</td></tr>"+"</table></div></div>"});s+='<a href="#" type="button" data-theme="a" id="results-clear">New search</a></div>';$("#results-panel").html(s);$("#results-panel").trigger("create");$("#search-panel").panel("close");$("#results-panel").panel("open");isSearch=false;$("#results-clear").on("click",function(e){$("#results-panel").panel("close");$("#search-panel").panel("open");clearMap();map.setOptions({styles:mapStylesGrayscale});isSearch=true});if(searchResult.length>0){onDisplayStations(0,n,r)}else{$.mobile.loading("hide")}isIgnoreCollapsible=false}).fail(function(e){$.mobile.loading("hide");alert("The server request timed out."+JSON.stringify(e))})}function onDisplayStations(e,t,n){clearMapDirections();var r=searchResult[e];var i=new google.maps.LatLng(r.station.start.latitude,r.station.start.longitude);var s=new google.maps.LatLng(r.station.arrive.latitude,r.station.arrive.longitude);var o=new google.maps.Marker({position:i,icon:mapMarkerBiciGreen,shadow:mapMarkerShadow,draggable:false,animation:google.maps.Animation.DROP,title:"Get Bike At"});var u=new google.maps.Marker({position:s,icon:mapMarkerBiciRed,shadow:mapMarkerShadow,draggable:false,animation:google.maps.Animation.DROP,title:"Leave Bike At"});map.setOptions({styles:mapStylesColor});google.maps.event.addListener(o,"click",function(){var e=new google.maps.InfoWindow({content:"<div><h3>Origin bicing station</h3><p><b>Station: </b>"+r.station.start.station_id+"</p>"+"<p><b>Address: </b>"+r.station.start.street+" "+r.station.start.street_number+"</p>"+"<p><b>Bikes now: </b>"+r.station.start.bikes+"</p>"+"<p><b>Bikes estimates: </b>"+r.station.start.estimation.bikes+"</p>"+"</div>"});e.open(map,o)});google.maps.event.addListener(u,"click",function(){var e=new google.maps.InfoWindow({content:"<div><h3>Destination bicing station</h3><p><b>Station: </b>"+r.station.arrive.station_id+"</p>"+"<p><b>Address: </b>"+r.station.arrive.street+" "+r.station.arrive.street_number+"</p>"+"<p><b>Slots now: </b>"+r.station.arrive.slots+"</p>"+"<p><b>Slots estimates: </b>"+r.station.arrive.estimation.slots+"</p>"+"</div>"});e.open(map,u)});mapMarkersStations.push(o);mapMarkersStations.push(u);for(var a=0;a<mapMarkersStations.length;a++){setTimeout(function(e){mapMarkersStations[e].setMap(map)},500*a,a)}onDisplayDirections(t,n,i,s)}function onDisplayDirections(e,t,n,r){mapDirections.route({origin:e,destination:n,travelMode:google.maps.DirectionsTravelMode.WALKING},function(e,t){if(t==google.maps.DirectionsStatus.OK){addDirectionsPath(e,pathOptionsWalkOrigin)}else{$.mobile.loading("hide");alert("No directions could be found.")}});mapDirections.route({origin:n,destination:r,travelMode:google.maps.DirectionsTravelMode.BICYCLING},function(e,t){if(t==google.maps.DirectionsStatus.OK){addDirectionsPath(e,pathOptionsBicing)}else{mapDirections.route({origin:n,destination:r,travelMode:google.maps.DirectionsTravelMode.WALKING},function(e,t){if(t==google.maps.DirectionsStatus.OK){addDirectionsPath(e,pathOptionsBicing)}else{$.mobile.loading("hide");alert("No directions could be found.")}})}});mapDirections.route({origin:r,destination:t,travelMode:google.maps.DirectionsTravelMode.WALKING},function(e,t){if(t==google.maps.DirectionsStatus.OK){addDirectionsPath(e,pathOptionsWalkDestination)}else{$.mobile.loading("hide");alert("No directions could be found.")}})}function addDirectionsPath(e,t){if(e.routes.length==0){return null}var n=e.routes[0];var r=[];$.each(n.legs,function(e,t){$.each(t.steps,function(e,t){r.push(t.start_location);r.push(t.end_location)})});var i=new google.maps.Polyline({path:r,geodesic:true});i.setOptions(t);mapPaths.push(i);i.setMap(map);$.mobile.loading("hide")}function clearMap(){for(var e=0;e<mapMarkersEnds.length;e++){mapMarkersEnds[e].setMap(null)}mapMarkersEnds=[];clearMapDirections()}function clearMapDirections(){for(var e=0;e<mapMarkersStations.length;e++){mapMarkersStations[e].setMap(null)}mapMarkersStations=[];for(var e=0;e<mapPaths.length;e++){mapPaths[e].setMap(null)}mapPaths=[]}function formatTime(e){var t=e.getDate();var n=e.getMonth()+1;var r=e.getFullYear();var i=e.getHours();var s=e.getMinutes();var o=e.getSeconds();if(t<10){t="0"+t}if(n<10){n="0"+n}if(i<10){i="0"+i}if(s<10){s="0"+s}if(o<10){o="0"+o}return r+"-"+n+"-"+t+"T"+i+":"+s+":"+o}function formatDistance(e){if(e<1e3)return e+" meters";else if(e<1e5)return Math.floor(e/1e3)+"."+Math.round(e%1e3/100)+" km";else return Math.round(e/1e3)+" km"}google.maps.visualRefresh=true;var map=null;var mapAutocomplete=null;var mapGeocoder=null;var mapDirections=null;var mapMarkersEnds=[];var mapMarkersStations=[];var mapPaths=[];var mapMarkerFlagRed;var mapMarkerFlagGreen;var mapMarkerFlagBlue;var mapMarkerFlagCyan;var mapMarkerFlagMagenta;var mapMarkerBiciRed;var mapMarkerBiciGreen;var mapMarkerBiciBlue;var mapMarkerBiciCyan;var mapMarkerBiciMagenta;var mapMarkerShadow;var mapInfoWndOrigin;var mapInfoWndDestination;var mapInfoWndOriginStation;var mapInfoWndDestinationStation;var mapStylesGrayscale=[{stylers:[{hue:"#000000"},{saturation:-100},{lightness:0}]}];var mapStylesColor=[{}];var strCurrentLocation="Current location";var isSearch=true;var isNow=true;var isIgnoreCollapsible=true;var searchResult=null;var pathOptionsWalkOrigin={strokeColor:"#00FF00",strokeOpacity:.8,strokeWeight:3};var pathOptionsBicing={strokeColor:"#0000FF",strokeOpacity:.8,strokeWeight:3};var pathOptionsWalkDestination={strokeColor:"#FF0000",strokeOpacity:.8,strokeWeight:3};$(document).ready(function(e){var t={center:new google.maps.LatLng(41.383333,2.183333),zoom:12,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:false,panControl:false,streetViewControl:false,zoomControl:false,styles:mapStylesGrayscale};mapMarkerFlagRed={url:"images/PinFlatFlagRed_50.png",size:google.maps.Size(50,50),origin:google.maps.Point(0,0),anchor:google.maps.Point(25,45)};mapMarkerFlagGreen={url:"images/PinFlatFlagGreen_50.png",size:google.maps.Size(50,50),origin:google.maps.Point(0,0),anchor:google.maps.Point(25,45)};mapMarkerFlagBlue={url:"images/PinFlatFlagBlue_50.png",size:google.maps.Size(50,50),origin:google.maps.Point(0,0),anchor:google.maps.Point(25,45)};mapMarkerFlagCyan={url:"images/PinFlatFlagCyan_50.png",size:google.maps.Size(50,50),origin:google.maps.Point(0,0),anchor:google.maps.Point(25,45)};mapMarkerFlagMagenta={url:"images/PinFlatFlagMagenta_50.png",size:google.maps.Size(50,50),origin:google.maps.Point(0,0),anchor:google.maps.Point(25,45)};mapMarkerBiciRed={url:"images/PinFlatBiciRed_50.png",size:google.maps.Size(50,50),origin:google.maps.Point(0,0),anchor:google.maps.Point(25,45)};mapMarkerBiciGreen={url:"images/PinFlatBiciGreen_50.png",size:google.maps.Size(50,50),origin:google.maps.Point(0,0),anchor:google.maps.Point(25,45)};mapMarkerBiciBlue={url:"images/PinFlatBiciBlue_50.png",size:google.maps.Size(50,50),origin:google.maps.Point(0,0),anchor:google.maps.Point(25,45)};mapMarkerBiciCyan={url:"images/PinFlatBiciCyan_50.png",size:google.maps.Size(50,50),origin:google.maps.Point(0,0),anchor:google.maps.Point(25,45)};mapMarkerBiciMagenta={url:"images/PinFlatBiciMagenta_50.png",size:google.maps.Size(50,50),origin:google.maps.Point(0,0),anchor:google.maps.Point(25,45)};mapMarkerShadow={url:"images/PinShadow_50.png",size:new google.maps.Size(34,17),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(2,17)};mapInfoWndOrigin=new google.maps.InfoWindow;mapInfoWndDestination=new google.maps.InfoWindow;mapInfoWndOriginStation=new google.maps.InfoWindow;mapInfoWndDestinationStation=new google.maps.InfoWindow;map=new google.maps.Map($("#map-canvas")[0],t);mapAutocomplete=new google.maps.places.AutocompleteService;mapGeocoder=new google.maps.Geocoder;mapDirections=new google.maps.DirectionsService;$("#search-panel").panel("open")});$(document).on("pageinit","#main-page",function(){$(document).on("swiperight","#main-page",function(e){if($.mobile.activePage.jqmData("panel")!=="open"){if(e.type==="swiperight"){$("#menu-panel").panel("open")}}});$("#navigation-search").on("click",function(e){$("#about-panel").panel("close");if(isSearch){$("#search-panel").panel("open")}else{$("#results-panel").panel("open")}});$("#search-panel").on("panelbeforeopen",function(e,t){var n=new Date;$("#search-date-time").val(formatTime(n))});$("#search-origin").change(function(e){onSearchInputChanged($(this),$("#search-origin-autocomplete"))});$("#search-destination").change(function(e){onSearchInputChanged($(this),$("#search-destination-autocomplete"))});$("#search-origin").focusin(function(e){if($(this).val()==strCurrentLocation){$(this).val("")}});$("#search-destination").focusin(function(e){if($(this).val()==strCurrentLocation){$(this).val("")}});$("#search-origin").keyup(function(e){onMapAutocomplete($(this),$("#search-origin-autocomplete"))});$("#search-destination").keyup(function(e){onMapAutocomplete($(this),$("#search-destination-autocomplete"))});$("#search-date-time-now").on("click",function(e){$("#search-date-time").textinput("disable");isNow=true});$("#search-date-time-custom").on("click",function(e){$("#search-date-time").textinput("enable");isNow=false});$("#search-form").on("submit",function(){return false});$("#search-start").on("click",function(e){onMapSearch()});$("#search-cancel").on("click",function(e){$("#search-panel").panel("close")});$("#menu-planner").on("click",function(e){$("#about-panel").panel("close");if(isSearch){$("#search-panel").panel("open")}else{$("#results-panel").panel("open")}});$("#menu-about").on("click",function(e){$("#about-panel").panel("open")});$(document).bind("expand",".result-collapsible",function(){if(isIgnoreCollapsible)return;alert("Expanded")}).bind("collapse",".result-collapsible",function(){if(isIgnoreCollapsible)return;$(this).find("[class='.result-collapsible']").trigger("expand");alert("Collapsed")})})